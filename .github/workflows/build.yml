name: SM64 Android Build
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r21e # This specific port needs an older NDK to work

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config git python3 wget zip

      - name: Download ROM
        run: |
          curl -L "${{ secrets.ROM_URL }}" -o baserom.us.z64

      - name: Prepare Assets
        run: |
          make -C tools
          python3 extract_assets.py us
          # Move textures where the Android C code expects them
          mkdir -p android/assets
          cp -r build/us_pc/res/* android/assets/ 2>/dev/null || true

      - name: Fix and Build with NDK
        run: |
          # 1. Navigate to the android folder
          cd android
          
          # 2. The previous error 'invalid token' usually means the XML is corrupted 
          # or uses features too new for the old NDK. We'll check it.
          cat AndroidManifest.xml
          
          # 3. Build using the NDK directly from inside the folder
          # We use 'V=1' to see EXACTLY what the compiler is doing if it fails
          ndk-build \
            NDK_PROJECT_PATH=. \
            APP_BUILD_SCRIPT=./Android.mk \
            NDK_APPLICATION_MK=./Application.mk \
            APP_ABI=arm64-v8a \
            V=1

      - name: Package Output
        run: |
          mkdir -p Finished_APK
          # In this old style, results go into 'libs' or 'obj'
          find android/libs/ -name "*.so" -exec cp {} Finished_APK/ \; || true
          
          # Zip the resulting library and assets. 
          # On Android, you can actually put these into a "Template APK" later.
          zip -j Finished_APK/sm64.arm64.zip Finished_APK/*.so
          
      - name: Upload to Releases
        uses: softprops/action-gh-release@v2
        with:
          files: Finished_APK/*
          tag_name: v1.${{ github.run_number }}
          name: SM64 Android Build #${{ github.run_number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
